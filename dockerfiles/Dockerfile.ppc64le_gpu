FROM carml/base:ppc64le-gpu-latest
MAINTAINER Abdul Dakkak <dakkak@illinois.edu>

# Build-time metadata as defined at http://label-schema.org
ARG BUILD_DATE
ARG VCS_REF
ARG VCS_URL
ARG VERSION
ARG ARCH
ARG FRAMEWORK_VERSION
LABEL org.carml.go-mxnet.build-date=$BUILD_DATE \
  org.carml.go-mxnet.name="go-mxnet gpu bindings for go" \
  org.carml.go-mxnet.description="" \
  org.carml.go-mxnet.url="https://www.carml.org/" \
  org.carml.go-mxnet.vcs-ref=$VCS_REF \
  org.carml.go-mxnet.vcs-url=$VCS_URL \
  org.carml.go-mxnet.vendor="MLModelScope" \
  org.carml.go-mxnet.arch=$ARCH \
  org.carml.go-mxnet.version=$VERSION \
  org.carml.go-mxnet.framework_version=$FRAMEWORK_VERSION \
  org.carml.go-mxnet.schema-version="1.0"

########## INSTALLATION STEPS ###################

RUN cd /usr/src/gtest && \
  cmake CMakeLists.txt && \
  make && \
  cp *.a /usr/lib

WORKDIR /
RUN git clone --single-branch --depth 1 --branch $FRAMEWORK_VERSION --recursive https://github.com/apache/incubator-mxnet mxnet

ENV MXNET_ROOT_DIR $FRAMEWORKS_DIR/mxnet

RUN ln -s /usr/local/cuda/lib64/stubs/libcuda.so /usr/local/cuda/lib64/stubs/libcuda.so.1

RUN cd mxnet && \
  mkdir -p /opt/mxnet &&  \
  cp make/config.mk . && \
  echo "USE_BLAS=openblas" >>config.mk && \
  echo "USE_CPP_PACKAGE=0" >>config.mk && \
  echo "USE_OPENCV=0" >>config.mk && \
  echo "USE_PROFILER=1" >>config.mk && \
  echo "USE_PYTHON=1" >>config.mk && \
  echo "USE_CUDA=1" >>config.mk && \
  echo "USE_CUDA_PATH=/usr/local/cuda" >>config.mk && \
  echo "CUDA_ARCH=-gencode=arch=compute_30,code=sm_30  -gencode=arch=compute_35,code=sm_35 -gencode=arch=compute_50,code=sm_50 -gencode=arch=compute_53,code=sm_53 -gencode=arch=compute_60,code=sm_60  -gencode=arch=compute_61,code=sm_61  -gencode=arch=compute_62,code=sm_62 -gencode=arch=compute_70,code=compute_70"  >>config.mk && \
  echo "USE_CUDNN=1" >>config.mk && \
  echo "ADD_CFLAGS=-I/usr/include/openblas -Wno-strict-aliasing -Wno-sign-compare -ftrack-macro-expansion=0 -Wno-misleading-indentation" >>config.mk && \
  echo "ADD_LDFLAGS=-L/usr/local/cuda/lib64" >>config.mk && \
  echo "ADD_LDFLAGS=-L/usr/local/cuda/lib64/stubs" >>config.mk && \
  make PREFIX=/opt/mxnet &&  \
  cp -r include /opt/mxnet/ && \
  cp -r lib /opt/mxnet/ && \
  rm -r build

RUN ln -s /opt/mxnet/lib/libmxnet.so /usr/lib/libmxnet.so
ENV LD_LIBRARY_PATH /usr/local/cuda/lib64:$LD_LIBRARY_PATH
ENV LD_LIBRARY_PATH /opt/mxnet/lib:$LD_LIBRARY_PATH
ENV LIBRARY_PATH /opt/mxnet/lib:$LIBRARY_PATH

# Get Go bindings
ENV PKG github.com/c3sr/go-mxnet
WORKDIR $GOPATH/src/$PKG

RUN git clone --depth=1 https://${PKG}.git . && \
  sed -i "/prefix=/c prefix=\/opt/mxnet" $GOPATH/src/github.com/c3sr/go-mxnet/travis/mxnet.pc && \
  cp $GOPATH/src/github.com/c3sr/go-mxnet/travis/mxnet.pc /usr/lib/pkgconfig && \
  pkg-config --libs mxnet && \
  cd $GOPATH/src/$PKG && \
  dep ensure -vendor-only && \
  go build -a -installsuffix cgo -ldflags "-s -w -X ${PKG}/Version=${VERSION} -X ${PKG}/GitCommit=${VCS_REF} -X ${PKG}/BuildDate=${BUILD_DATE}"&& \
  go install && \
  rm -fr vendor

